- name: Déployer / mettre à jour la stack Docker Compose db-admin-ville-marseille
  hosts: db_servers
  become: false       
  gather_facts: true

  vars:
    project_dir: "{{ playbook_dir }}/../.."

  tasks:
    - name: Afficher le répertoire du projet (debug)
      ansible.builtin.debug:
        msg: "project_dir = {{ project_dir }}"

    - name: Vérifier si Docker est disponible
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Vérifier si docker compose est disponible
      ansible.builtin.command: docker compose version
      register: compose_version
      changed_when: false

    - name: Démarrer / mettre à jour la stack Docker Compose
      ansible.builtin.shell: |
        docker compose pull || true
        docker compose up -d --remove-orphans
      args:
        chdir: "{{ project_dir }}"
