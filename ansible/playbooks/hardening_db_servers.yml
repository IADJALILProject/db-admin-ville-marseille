- name: Basic PostgreSQL hardening and backups
  hosts: db_servers
  become: true

  vars:
    effective_pg_version: "{{ postgres_version | default('15') }}"
    effective_conf_dir: "{{ db_conf_dir | default('/etc/postgresql/15/main') }}"
    effective_backup_dir: "{{ db_backup_dir | default('/var/backups/postgres') }}"
    effective_psql_bin: "{{ psql_bin | default('/usr/bin/psql') }}"

  tasks:
    - name: Enable detailed logging in postgresql.conf
      ansible.builtin.blockinfile:
        path: "{{ effective_conf_dir }}/postgresql.conf"
        marker: "# {mark} ANSIBLE-LOGGING"
        block: |
          logging_collector = on
          log_line_prefix = '%m [%p] %u@%d '
          log_min_duration_statement = 500
          log_checkpoints = on
          log_connections = on
          log_disconnections = on
      notify: Reload PostgreSQL

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ effective_backup_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: '0750'

    - name: Install simple logical backup script
      ansible.builtin.copy:
        dest: /usr/local/sbin/pg_backup_rotate.sh
        owner: root
        group: root
        mode: '0755'
        content: |
          #!/usr/bin/env bash
          set -euo pipefail

          BACKUP_DIR="{{ effective_backup_dir }}"
          DB_NAME="{{ db_name }}"
          TS="$(date +%Y%m%d_%H%M%S)"
          FILE="${BACKUP_DIR}/${DB_NAME}_${TS}.dump"

          mkdir -p "${BACKUP_DIR}"
          sudo -u postgres {{ effective_psql_bin | dirname }}/pg_dump -Fc "${DB_NAME}" > "${FILE}"

          # Keep last 7 backups
          ls -1t "${BACKUP_DIR}"/${DB_NAME}_*.dump | tail -n +8 | xargs -r rm -f

    - name: Schedule nightly backup
      ansible.builtin.cron:
        name: "PostgreSQL logical backup ({{ db_name }})"
        user: root
        minute: "30"
        hour: "2"
        job: "/usr/local/sbin/pg_backup_rotate.sh >/var/log/pg_backup_rotate.log 2>&1"

  handlers:
    - name: Reload PostgreSQL
      ansible.builtin.service:
        name: postgresql
        state: reloaded
