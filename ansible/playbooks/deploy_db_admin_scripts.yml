- name: Deploy db-admin repo and run migrations
  hosts: db_servers
  become: true

  vars:
    # Racine du projet = un niveau au-dessus du dossier ansible/
    project_root: "{{ playbook_dir | dirname | dirname }}"

    repo_dst_remote: "{{ db_admin_repo_root | default('/opt/db_admin/repo') }}"
    scripts_dst_remote: "{{ db_admin_scripts_dir | default('/opt/db_admin/scripts') }}"

    ddl_glob: "{{ project_root }}/db/postgres/ddl/*.sql"
    dml_glob: "{{ project_root }}/db/postgres/dml/*.sql"

    ddl_files_in_order:
      - "{{ repo_dst_remote }}/db/postgres/ddl/01_create_schema_referentiel.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/02_create_schema_metier.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/03_create_tables_referentiel.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/04_create_tables_citoyens_rdv.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/05_indexes_constraints.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/06_views_reporting.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/07_functions_rdv.sql"
      - "{{ repo_dst_remote }}/db/postgres/ddl/08_monitoring_schema.sql"

  tasks:
    - name: Show target repo path
      ansible.builtin.debug:
        msg:
          - "project_root={{ project_root }}"
          - "repo_dst_remote={{ repo_dst_remote }}"
          - "scripts_dst_remote={{ scripts_dst_remote }}"
          - "ddl_glob={{ ddl_glob }}"
          - "dml_glob={{ dml_glob }}"

    - name: Ensure target directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ repo_dst_remote }}"
        - "{{ repo_dst_remote }}/db/postgres/ddl"
        - "{{ repo_dst_remote }}/db/postgres/dml"
        - "{{ scripts_dst_remote }}"

    - name: Copy SQL DDL scripts to remote repo
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ repo_dst_remote }}/db/postgres/ddl/"
        mode: "0644"
      with_fileglob:
        - "{{ ddl_glob }}"

    - name: Copy SQL DML scripts to remote repo
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ repo_dst_remote }}/db/postgres/dml/"
        mode: "0644"
      with_fileglob:
        - "{{ dml_glob }}"

    - name: Apply DDL scripts on {{ db_name }} (ordered)
      ansible.builtin.shell: >
        sudo -u postgres {{ psql_bin | default('/usr/bin/psql') }}
        -d {{ db_name }}
        {{ psql_flags | default('-v ON_ERROR_STOP=1 --quiet') }}
        -f "{{ item }}"
      loop: "{{ ddl_files_in_order }}"

    # ⬇⬇ ICI on ne joue PLUS 11_insert_demo_from_csv.sql ⬇⬇
    - name: Apply DML scripts on {{ db_name }} (seed + reseed only)
      ansible.builtin.shell: >
        sudo -u postgres {{ psql_bin | default('/usr/bin/psql') }}
        -d {{ db_name }}
        {{ psql_flags | default('-v ON_ERROR_STOP=1 --quiet') }}
        -f "{{ item }}"
      loop:
        - "{{ repo_dst_remote }}/db/postgres/dml/10_seed_referentiel.sql"
        - "{{ repo_dst_remote }}/db/postgres/dml/12_reseed_sequences.sql"
